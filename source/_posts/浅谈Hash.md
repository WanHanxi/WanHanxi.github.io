---
title: 浅谈Hash
date: 2020-12-28 15:01:52
categories: 科普
---

# 引子

下载大文件时，我们经常在网页中发现“SHA-1”字样后面跟着一串神秘代码，也经常在一些压缩包属性里看到一串不明所以的“md5”。也许你我从未关注过这串代码——毕竟文件下好了就能直接打开，谁会在意这串没啥用的东西？

这其实是用来检验文件完整性的“密钥”——或许是 Hash 在日常生活中最显而易见的应用。听起来很寒酸？但它在计算机中有着十分重要的作用。

<!--more-->

# Hash是什么

> **散列**（英语：Hashing）是电脑科学中一种对数据的处理方法，通过某种特定的函数/算法（称为**散列函数**/算法，例如md5、SHA-1等）将要检索的项与用来检索的索引（称为**散列**，或者**散列值**）关联起来，生成一种便于搜索的数据结构（称为**散列表**）。旧译**哈希**（误以为是人名而采用了音译）。

（维基百科）

简单来说，散列就是一个给任意大小的文件，按一定规律生成固定长度的“身份证号”的过程。无论原始信息是0字节还是1亿字节，都能“有损压缩”成一串短小的字符，这串字符称为 Hash 值（散列值）。



# 特性

1. **单向性**

   给定原始信息，能容易地生成散列；但无法根据散列还原出原始信息。

2. **唯一性**

   当原始信息一致时，生成的散列也是一致的。只要用同一种算法，无论是谁都能得到一样的散列值。

3. **不可预测性**

   原始信息中微小的改动也能让散列值大不一样。

   **举个栗子**

   原始信息：**MD5(JI Science)=7acdd402dd89312a**

   当我们把最后一个字母改成大写之后：**MD5(JI SciencE)=91b09273090187c3**
   
   是不是完全无迹可寻？

具备了这几个特点，Hash 又有哪些重要的应用呢？




# 应用

## 完整性校验

正如开头所提到的，Hash 值的不可预测性可以帮助我们判断文件在传输过程中是否完整。通过比对传输前后的 Hash 值，可以确保获得的文件与站点提供的文件为同一文件，避免受损或者被篡改。利用MD5算法来进行文件校验的方案被大量应用到软件下载站、论坛数据库、系统文件安全校验等方面。

![Raspbian Buster Download](https://s2.ax1x.com/2020/02/12/17QSiV.png)

上图是某操作系统的下载页面，给出了使用 SHA-256 算法得出的 Hash 值。下载完毕后我们通过命令行即可得出已下载文件的 Hash 值。

```
certutil -hashfile  <文件名>  <hash类型>
```

![Hash检验](https://s2.ax1x.com/2020/02/12/17Q4OJ.png)

##　数字签名

第三方认证机构可以根据“完整性检验”颁发数字签名，确保信息安全。

例如小A写了一个文件，认证机构对此文件用散列算法计算出**数据指纹**并做好记录。若以后小A的文件遭到了篡改，或者文件的版权出现了争议，那么认证机构只需对此文件重新生成数据指纹，然后跟记录在册的指纹进行比对。如果匹配成功，就证明是小A写的了。这就是所谓的“数字签名”。

## 网盘“秒”传

我们上传到网盘的每个文件，服务器都会生成一份 MD5 值。如果**其他人上传文件**的 MD5 值与**数据库**里 MD5 值匹配的话，网盘就会判断成为**重复文件**，只需复制副本保存在其他人的网盘内即可，无需重复上传。这样既节省了上传时间，也减轻了带宽和服务器压力。当然，这背后的隐私问题也让这项应用成为了国内网盘的一大“特色”。

##　登录认证

散列算法也被用来加密存在数据库中的密码字符串，由于散列算法所计算出来的散列值具有不可逆（无法逆向演算回原本的数值）的性质，因此可有效的保护密码。

**客户端**

直接将用户输入的密码进行 Hash 运算，得到结果发送给服务器验证。因为 Hash 算法无法逆运算，所以就算 Hash 值泄露，用户真实密码也不会泄露。

**服务端**

在用户注册的时候，服务端的数据库中保存的就是用户密码的 Hash 值，而不是密码本身。这样就算服务器被攻克，用户的隐私信息也能起到一定的保护。

这也就是为什么现在各类产品只提供**重置密码**的功能，而无法**找回密码**了：即使是服务端，也不知道用户的真实密码。



## 真的安全吗？

既然散列函数的输入和输出不是唯一对应关系的，那么可能出现两个不同的输入得到相同的散列值，这种情况称为**散列碰撞**（collision）

防止散列碰撞的最有效方法，就是扩大散列值的取值空间。16个二进制位的散列值，产生碰撞的可能性是 65536 分之一。也就是说，如果有65537个用户，就一定会产生碰撞。散列值的长度扩大到32个二进制位，碰撞的可能性就会下降到 4,294,967,296 分之一。

事实上，常见的 MD5 算法已经发生了碰撞，其余算法情况详见下表：

![散列算法](https://i.loli.net/2020/02/12/WADbZXOkLQuwYGj.png)



那不存在散列碰撞的算法就绝对安全吗？

很不幸，答案是否定的。因为用户的密码是比较短的，而且很多用户的密码都使用生日，手机号码，或是常用的一些吉利的数字、某些英文单词。如果把常用的密码先 Hash 处理，建立数据库，这时就有可能通过匹配得到明文密码。这样的数据库称为**彩虹表**。



某知名解密网站的公告这样写道：

> 本站针对md5、sha1等全球通用公开的加密算法进行反向查询，通过穷举字符组合的方式，创建了明文密文对应查询数据库，创建的记录约90万亿条，占用硬盘超过500TB，查询成功率95%以上，很多复杂密文只有本站才可查询。自2006年已稳定运行十余年，国内外享有盛誉。

查询简单的明文的确轻而易举：

![解密123456](https://i.loli.net/2020/02/12/gAQE7Dpuwkrt8FM.png)



在彩虹表面前，单纯的 Hash 运算不堪一击，怎么办？



# 加盐

> **盐**，是指在散列之前，在散列内容（例如：密码）的任意固定位置插入的特定字符串。

（维基百科）

盐可以是任意字母、数字、或是字母或数字的组合，但必须是随机产生的，每个用户的盐都不一样。用户注册的时候，数据库中存入的不是明文密码，也不是简单地对明文密码进行散列，而是 Hash（明文密码 + 盐）的结果。



**举个栗子**

张三的密码是123，李四的密码是456。注册的时候会随机生成一段用户专属的盐，然后上传这样一段 Hash 值：

```
//以MD5算法为例
MD5('123' + '1ck12b13k1jmjxrg1h0129h2lj') = '6c22ef52be70e11b6f3bcf0f672c96ce'
MD5('456' + '1h029kh2lj11jmjxrg13k1c12b') = '7128f587d88d6686974d6ef57c193628'
```

服务器中这样存储数据：

```
+----------+----------------------------+----------------------------------+
| UserName | Salt                       | PwdHash                          |
+----------+----------------------------+----------------------------------+
| ZhangSan | 1ck12b13k1jmjxrg1h0129h2lj | 6c22ef52be70e11b6f3bcf0f672c96ce |
| LiSi     | 1h029kh2lj11jmjxrg13k1c12b | 7128f587d88d6686974d6ef57c193628 |
+----------+----------------------------+----------------------------------+
```



当用户登陆时，同样用这种算法进行验证即可。由于加了盐，即便数据库泄露了，但是由于密码都是加了盐之后的散列值，黑客们的数据字典已经无法直接匹配，明文被破解出来的概率也大大降低。

实际项目中，盐不一定要加在最前面或最后面，也可以插在中间，或分开插入，甚至可以倒序。程序设计时可以灵活调整，都可以使破解的难度指数级增长。

## 结语

从上文中可以看出Hash的在计算机世界扮演着多么重要的角色。「The Algorithm Design Manual」一书中还举了一个现实中很有趣的例子：

一场拍卖会中，物品是价高者得，如果每个人只有一次出价机会，同时提交自己的价格后，最后一起公布，出价最高则胜出。这种形式存在作弊的可能，如果有出价者能黑进后台，然后将自己的价格改为最高价 +1，则能以最低的代价获得胜利。如何杜绝这种作弊呢？

答案很简单，参与者都提交自身出价的 Hash 值就可以了，即使有人能黑进后台也无法得知明文价格，等到公布之时，再对比原出价与 Hash 值是否对应即可。

这样的做法，与上文提到的网站上储存密码用 MD5 值而非明文，是同一种思想，殊途同归。可以看到无论是密码学还是现实生活中的应用，到处都是 Hash 的影子。希望本文能帮助你体会到 Hash 的精妙之处。







# 参考

http://www.cmd5.com/

https://www.jianshu.com/p/fd3382b6aea1

https://zh.wikipedia.org/wiki/散列

http://www.ruanyifeng.com/blog/2018/09/hash-collision-and-birthday-attack.html

https://www.jianshu.com/p/bf1d7eee28d0

注：此文首次发布于密院科协 JIScience板块